#!/usr/bin/env zsh
# Repair script for QuickSaveAlias on macOS/Zsh
# This script fixes common issues with QuickSaveAlias installations

echo "QuickSaveAlias Repair Script for macOS/Zsh"
echo "==========================================="
echo ""

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Step 1: Backup existing files
echo "Step 1: Creating backups..."
if [ -f ~/.quicksavealias.sh ]; then
    cp ~/.quicksavealias.sh ~/.quicksavealias.sh.backup
    echo "  ✓ Backed up ~/.quicksavealias.sh"
fi

if [ -f ~/.zsh-aliases ]; then
    cp ~/.zsh-aliases ~/.zsh-aliases.backup
    echo "  ✓ Backed up ~/.zsh-aliases"
fi

if [ -f ~/.zsh_special_aliases.sh ]; then
    cp ~/.zsh_special_aliases.sh ~/.zsh_special_aliases.sh.backup
    echo "  ✓ Backed up ~/.zsh_special_aliases.sh"
fi

echo ""

# Step 2: Install latest version
echo "Step 2: Installing latest version..."
if [ -f "$SCRIPT_DIR/quicksavealias_mac.sh" ]; then
    cp "$SCRIPT_DIR/quicksavealias_mac.sh" ~/.quicksavealias.sh
    chmod +x ~/.quicksavealias.sh
    echo "  ✓ Installed quicksavealias_mac.sh to ~/.quicksavealias.sh"
else
    echo "  ✗ Error: quicksavealias_mac.sh not found in $SCRIPT_DIR"
    exit 1
fi

if [ -f "$SCRIPT_DIR/zsh_special_aliases.sh" ]; then
    cp "$SCRIPT_DIR/zsh_special_aliases.sh" ~/.zsh_special_aliases.sh
    chmod +x ~/.zsh_special_aliases.sh
    echo "  ✓ Installed zsh_special_aliases.sh to ~/.zsh_special_aliases.sh"
else
    echo "  ✗ Error: zsh_special_aliases.sh not found in $SCRIPT_DIR"
    exit 1
fi

echo ""

# Step 3: Fix .zshrc if needed
echo "Step 3: Checking .zshrc configuration..."
NEEDS_UPDATE=false

if ! grep -q "quicksavealias.sh -install" ~/.zshrc; then
    echo "  + Adding QuickSaveAlias initialization to ~/.zshrc"
    echo "" >> ~/.zshrc
    echo "# Install QuickSaveAlias for the session" >> ~/.zshrc
    echo "[ -e ~/.quicksavealias.sh ] && source ~/.quicksavealias.sh -install" >> ~/.zshrc
    NEEDS_UPDATE=true
fi

# Remove old direct sourcing if it exists
if grep -q "source ~/.zsh-aliases" ~/.zshrc 2>/dev/null; then
    echo "  - Removing old direct .zsh-aliases sourcing"
    sed -i '' '/source ~\/.zsh-aliases/d' ~/.zshrc
    NEEDS_UPDATE=true
fi

if ! grep -q "source ~/.zsh_special_aliases.sh" ~/.zshrc; then
    echo "  + Adding special aliases helper to ~/.zshrc"
    echo "" >> ~/.zshrc
    echo "# Load all aliases including special character aliases" >> ~/.zshrc
    echo "[ -f ~/.zsh_special_aliases.sh ] && source ~/.zsh_special_aliases.sh" >> ~/.zshrc
    NEEDS_UPDATE=true
fi

if [ "$NEEDS_UPDATE" = false ]; then
    echo "  ✓ .zshrc is already properly configured"
fi

echo ""

# Step 4: Fix existing aliases file
echo "Step 4: Fixing aliases file format..."
if [ -f ~/.zsh-aliases ]; then
    # Load functions from the script
    source ~/.quicksavealias.sh
    
    # Fix the aliases file 
    echo "  → Running fixal to repair alias format..."
    fixal 2>&1 | sed 's/^/    /'
else
    echo "  ℹ No existing .zsh-aliases file found - will be created on first use"
    # Create an empty one
    echo "# Zsh aliases file - auto-generated by QuickSaveAlias" > ~/.zsh-aliases
    echo "# Special character aliases are managed in ~/.zsh_special_aliases.sh" >> ~/.zsh-aliases
fi

echo ""
echo "==========================================="
echo "Repair Complete!"
echo ""
echo "Backups created:"
echo "  - ~/.quicksavealias.sh.backup (if existed)"
echo "  - ~/.zsh-aliases.backup (if existed)"
echo "  - ~/.zsh_special_aliases.sh.backup (if existed)"
echo ""
echo "To apply changes, run:"
echo "  source ~/.zshrc"
echo ""
echo "Or restart your terminal."
echo ""

